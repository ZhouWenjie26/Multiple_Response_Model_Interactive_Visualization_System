[{"name":"app.R","content":"# ==============================================================================\r\n# MRM-LD Interactive Visualization System (Optimized)\r\n# Multiple Response Model with Inter-option Local Dependencies\r\n# \r\n# Reference: Zhou & Guo (2026). Psychometric Model Framework for Multiple Response Items\r\n# Psychometrika. doi:10.1017/psy.2025.10073\r\n# ==============================================================================\r\n\r\nlibrary(shiny)\r\nlibrary(ggplot2)\r\nif (FALSE) {\r\n  library(munsell)\r\n}\r\n# Removed: tidyr (unused), dplyr replaced with base R\r\n\r\n# ==============================================================================\r\n# 1. Core Functions (Optimized)\r\n# ==============================================================================\r\n\r\nget_all_patterns <- function(O_j) {\r\n  as.matrix(expand.grid(replicate(O_j, 0:1, simplify = FALSE)))\r\n}\r\n\r\nfilter_patterns <- function(full_patterns, itemtype, Key) {\r\n  row_sums <- rowSums(full_patterns)\r\n  T_correct <- sum(Key)\r\n  keep <- switch(itemtype,\r\n                 \"MTF\" = rep(TRUE, nrow(full_patterns)),\r\n                 \"CMS\" = row_sums >= 1,\r\n                 \"Select-N\" = row_sums == T_correct,\r\n                 rep(TRUE, nrow(full_patterns)))\r\n  full_patterns[keep, , drop = FALSE]\r\n}\r\n\r\ncalculate_ps_scores <- function(patterns, Key) {\r\n  rowSums(patterns == matrix(Key, nrow(patterns), length(Key), byrow = TRUE))\r\n}\r\n\r\ncalculate_mrm_ld_prob <- function(theta, a, d, a_star, gamma, Key, patterns) {\r\n  n_theta <- length(theta)\r\n  n_patterns <- nrow(patterns)\r\n  W <- ifelse(Key == 1, 1, -1)\r\n  h_base <- d + W * a_star * gamma\r\n  probs_matrix <- matrix(0, n_patterns, n_theta)\r\n  patterns_a <- as.vector(patterns %*% a)\r\n  patterns_base <- as.vector(patterns %*% h_base)\r\n  for (i in seq_len(n_theta)) {\r\n    log_kernels <- patterns_a * theta[i] + patterns_base\r\n    kernels <- exp(log_kernels - max(log_kernels))\r\n    probs_matrix[, i] <- kernels / sum(kernels)\r\n  }\r\n  pattern_strings <- apply(patterns, 1, paste, collapse = \"\")\r\n  scores <- calculate_ps_scores(patterns, Key)\r\n  data.frame(Theta = rep(theta, each = n_patterns), Pattern = rep(pattern_strings, n_theta),\r\n             Score = rep(scores, n_theta), Prob = as.vector(probs_matrix))\r\n}\r\n\r\ncalculate_mrm_info <- function(theta, a, d, a_star, gamma, Key, patterns) {\r\n  n_theta <- length(theta)\r\n  W <- ifelse(Key == 1, 1, -1)\r\n  h_base <- d + W * a_star * gamma\r\n  a_x <- as.vector(patterns %*% a)\r\n  patterns_base <- as.vector(patterns %*% h_base)\r\n  info_vec <- numeric(n_theta)\r\n  for (i in seq_len(n_theta)) {\r\n    log_kernels <- a_x * theta[i] + patterns_base\r\n    kernels <- exp(log_kernels - max(log_kernels))\r\n    p_vec <- kernels / sum(kernels)\r\n    info_vec[i] <- sum(a_x^2 * p_vec) - sum(a_x * p_vec)^2\r\n  }\r\n  info_vec\r\n}\r\n\r\ncalculate_mrm_info_marginal <- function(theta, a, d, a_star, Key, patterns) {\r\n  g_points <- seq(-3, 3, length.out = 15)\r\n  g_weights <- dnorm(g_points); g_weights <- g_weights / sum(g_weights)\r\n  info_marginal <- numeric(length(theta))\r\n  for (k in seq_along(g_points)) {\r\n    info_marginal <- info_marginal + calculate_mrm_info(theta, a, d, a_star, g_points[k], Key, patterns) * g_weights[k]\r\n  }\r\n  info_marginal\r\n}\r\n\r\n# ==============================================================================\r\n# 2. UI Layout (Original text preserved)\r\n# ==============================================================================\r\n\r\nui <- fluidPage(\r\n  theme = bslib::bs_theme(version = 4, bootswatch = \"flatly\"),\r\n  tags$head(\r\n    tags$script(src = \"https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-MML-AM_CHTML\", defer = NA),\r\n    tags$script(HTML(\"if(window.MathJax){MathJax.Hub.Config({tex2jax:{inlineMath:[['$','$'],['\\\\\\\\(','\\\\\\\\)']]}});}\")),\r\n    tags$style(HTML(\"\r\n      body { font-size: 15px; }\r\n      .well { background-color: #f8f9fa; border: 1px solid #e9ecef; }\r\n      h4 { color: #2c3e50; font-weight: 600; font-size: 1.25rem; margin-top: 18px; }\r\n      h5 { font-size: 1.15rem; font-weight: 600; color: #2c3e50; }\r\n      .model-intro { background-color: #e8f4f8; border-left: 4px solid #3498db; padding: 15px; margin: 10px 0; border-radius: 4px; font-size: 14px; }\r\n      .formula-box { background-color: #ffffff; border: 1px solid #ddd; padding: 20px; border-radius: 4px; margin: 15px 0; overflow-x: auto; }\r\n      .formula-box .MathJax, .formula-box .MathJax span, .formula-box .help-block { color: #000000 !important; }\r\n      .score-note { background-color: #f5f5f5; border: 1px solid #e0e0e0; padding: 10px 15px; border-radius: 4px; margin: 5px 0; font-size: 13px; color: #555; }\r\n      .symbol-def { padding: 10px 8px; margin: 4px 0; border-bottom: 1px solid #eee; font-size: 14px; line-height: 1.5; }\r\n      .symbol-def:last-child { border-bottom: none; }\r\n      .param-name { font-weight: 600; color: #2c3e50; font-style: italic; }\r\n      .item-type-desc { font-size: 13px; color: #555; margin-top: 5px; padding: 10px; background-color: #f5f5f5; border-radius: 4px; line-height: 1.5; }\r\n      .sidebar-label { font-weight: 600; margin-bottom: 3px; font-size: 14px; }\r\n      .form-group { margin-bottom: 12px; }\r\n      .slider-container { margin-bottom: 15px; }\r\n      .selectize-input, .form-control { font-size: 14px; }\r\n      .param-header-row { display: flex !important; flex-wrap: nowrap !important; align-items: center; margin-bottom: 5px; }\r\n      .param-header-row .param-label-col { flex: 0 0 16.67%; max-width: 16.67%; min-width: 30px; }\r\n      .param-header-row .param-input-col { flex: 0 0 41.67%; max-width: 41.67%; text-align: center; font-weight: bold; font-size: 14px; padding: 0 5px; }\r\n      .param-row { display: flex !important; flex-wrap: nowrap !important; align-items: center; margin-bottom: 8px; }\r\n      .param-row .param-label-col { flex: 0 0 16.67%; max-width: 16.67%; min-width: 30px; padding-top: 8px; font-weight: bold; font-size: 14px; }\r\n      .param-row .param-input-col { flex: 0 0 41.67%; max-width: 41.67%; padding: 0 5px; }\r\n      .param-row .param-input-col .form-group { margin-bottom: 0; }\r\n      @media (max-width: 576px) { .param-header-row .param-input-col, .param-row .param-label-col { font-size: 12px; } .param-row .param-input-col input { font-size: 12px; padding: 4px 6px; } }\r\n      .ld-warning { background-color: #fff3cd; border: 1px solid #ffc107; color: #856404; padding: 10px; border-radius: 4px; margin-bottom: 10px; font-size: 12px; }\r\n      .key-warning { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 10px; border-radius: 4px; margin-top: 10px; font-size: 12px; }\r\n      .citation-footer { background-color: #f8f9fa; border-top: 1px solid #dee2e6; padding: 15px 20px; margin-top: 30px; text-align: center; font-size: 13px; color: #6c757d; }\r\n      .citation-footer a { color: #007bff; text-decoration: none; }\r\n      .citation-footer a:hover { text-decoration: underline; }\r\n    \"))\r\n  ),\r\n  \r\n  titlePanel(h3(\"Multiple Response Model - Interactive Visualization System\", style = \"font-weight: 600; color: #2c3e50;\")),\r\n  \r\n  sidebarLayout(\r\n    sidebarPanel(width = 3,\r\n                 div(class = \"model-intro\",\r\n                     h5(\"Model Overview\", style = \"margin-top: 0;\"),\r\n                     p(\"MRM-LD (Multiple Response Model with Inter-option Local Dependencies) is an IRT model framework \",\r\n                       \"for Multiple Response (MR) items. Based on the divide-by-total structure, it directly models the probability of each Response Combination (RC) \",\r\n                       \"without compressing RC data into scores, and captures inter-option local dependencies within items.\")),\r\n                 h4(\"1. Item Configuration\"),\r\n                 fluidRow(\r\n                   column(6, selectInput(\"itemtype\", \"Item Type\", choices = c(\"MTF\", \"CMS\", \"Select-N\"), selected = \"MTF\")),\r\n                   column(6, numericInput(\"O_j\", HTML(\"O<sub>j<\/sub> (Options)\"), value = 4, min = 2, max = 8, step = 1))),\r\n                 uiOutput(\"oj_warning_ui\"),\r\n                 div(class = \"item-type-desc\",\r\n                     HTML(\"<b>MTF<\/b> = Multiple True-False<br>\"),\r\n                     HTML(\"<b>CMS<\/b> = Conventional Multiple-Select<br>\"),\r\n                     HTML(\"<b>Select-N<\/b> = Select exactly N options<br><br>\"),\r\n                     HTML(\"X<sub>j<\/sub>: MTF = 2<sup>O<sub>j<\/sub><\/sup>; CMS = 2<sup>O<sub>j<\/sub><\/sup> ‚àí 1; \"),\r\n                     HTML(\"Select-N = C(O<sub>j<\/sub>, T).\")),\r\n                 h5(\"Answer Key\", style = \"margin-top: 15px;\"),\r\n                 uiOutput(\"key_ui\"),\r\n                 uiOutput(\"key_warning_ui\"),\r\n                 hr(),\r\n                 div(style = \"display:flex; justify-content:space-between; align-items:center;\",\r\n                     h4(\"2. Option Parameters\"),\r\n                     actionButton(\"random_btn\", \"Randomize\", icon = icon(\"dice\"), class = \"btn-info btn-sm\")),\r\n                 uiOutput(\"dynamic_params_ui\"),\r\n                 conditionalPanel(condition = \"input.itemtype == 'Select-N'\",\r\n                                  checkboxInput(\"normalize_selectn\", \"Apply sum-to-zero constraint\", value = TRUE),\r\n                                  tags$div(style = \"font-size: 13px; color: #666;\", HTML(\"For Select-N identifiability: &Sigma;a = 0 and &Sigma;d = 0\"))),\r\n                 hr(),\r\n                 h4(\"3. Local Dependence\"),\r\n                 uiOutput(\"ld_warning_ui\"),\r\n                 div(class = \"slider-container\",\r\n                     tags$div(class = \"sidebar-label\", HTML(\"a*<sub>j<\/sub> (LD Magnitude)\")),\r\n                     sliderInput(\"a_star\", NULL, min = 0, max = 3, value = 0.5, step = 0.1)),\r\n                 div(class = \"slider-container\",\r\n                     tags$div(class = \"sidebar-label\", HTML(\"&gamma;<sub>ij<\/sub> (Specific Factor)\")),\r\n                     sliderInput(\"gamma\", NULL, min = -3, max = 3, value = 0, step = 0.1)),\r\n                 checkboxInput(\"show_marginal\", HTML(\"Integrate over &gamma; (marginal probability)\"), value = FALSE),\r\n                 hr(),\r\n                 h4(\"4. Display Range\"),\r\n                 fluidRow(\r\n                   column(6, numericInput(\"x_min\", HTML(\"&theta; min\"), value = -4, step = 0.5)),\r\n                   column(6, numericInput(\"x_max\", HTML(\"&theta; max\"), value = 4, step = 0.5)))\r\n    ),\r\n    \r\n    mainPanel(width = 9,\r\n              fluidRow(\r\n                column(8, \r\n                       plotOutput(\"rccc_plot\", height = \"560px\"),\r\n                       div(class = \"score-note\",\r\n                           tags$b(\"Note: \"), \"Response Combinations (RCs) are grouped by Partial Scoring (PS) = number of options matching the answer key. \",\r\n                           \"The cumulative curve shows the sum of all RC probabilities at each score level.\")),\r\n                column(4, \r\n                       wellPanel(style = \"height: 620px; overflow-y: auto; padding: 12px;\",\r\n                                 h5(HTML(\"Design Matrix Z<sub>j<\/sub>\"), style = \"margin-top: 0;\"),\r\n                                 tags$div(style = \"font-size: 12px; color: #666; margin-bottom: 10px;\",\r\n                                          HTML(\"Z<sub>jxo<\/sub> = 1 if option <i>o<\/i> is selected in RC <i>x<\/i>, 0 otherwise.\")),\r\n                                 tableOutput(\"z_matrix_display\")))),\r\n              fluidRow(\r\n                column(8, plotOutput(\"info_plot\", height = \"320px\")),\r\n                column(4, wellPanel(style = \"height: 320px; overflow-y: auto;\",\r\n                                    h5(\"Current Item Summary\"),\r\n                                    verbatimTextOutput(\"info_params_display\")))),\r\n              div(class = \"formula-box\",\r\n                  h4(\"MRM-LD Model Specification\", style = \"color: #2c3e50; margin-top: 0;\"),\r\n                  fluidRow(\r\n                    column(6,\r\n                           h5(\"Core Formulas\", style = \"color: #000;\"),\r\n                           tags$div(style = \"margin-bottom: 15px; color: #000;\",\r\n                                    tags$b(\"Formula (5) - Option Attractiveness:\", style = \"color: #000;\"),\r\n                                    withMathJax(tags$div(style = \"color: #000;\", \"$$h'_{ijo} = a_{jo}\\\\theta_i + d_{jo} + W_{jo}a^*_j\\\\gamma_{ij}$$\"))),\r\n                           tags$div(style = \"margin-bottom: 15px; color: #000;\",\r\n                                    tags$b(\"Formula (6) - Response Combination Probability Function (RCPF):\", style = \"color: #000;\"),\r\n                                    withMathJax(tags$div(style = \"color: #000;\", \"$$P(Y_{ij} = x | \\\\theta_i) = \\\\frac{\\\\exp\\\\left(\\\\sum_{o=1}^{O_j} Z_{jxo} h'_{ijo}\\\\right)}{\\\\sum_{m=1}^{X_j} \\\\exp\\\\left(\\\\sum_{o=1}^{O_j} Z_{jmo} h'_{ijo}\\\\right)}$$\"))),\r\n                           tags$div(style = \"color: #000;\",\r\n                                    tags$b(\"Formula (21) - Item Information Function:\", style = \"color: #000;\"),\r\n                                    withMathJax(tags$div(style = \"color: #000;\", \"$$I(\\\\theta) = \\\\sum_{x=1}^{X_j} \\\\left[\\\\sum_{o=1}^{O_j} a_{jo} Z_{jxo}\\\\right]^2 P(x|\\\\theta) - \\\\left[\\\\sum_{x=1}^{X_j} \\\\sum_{o=1}^{O_j} a_{jo} Z_{jxo} P(x|\\\\theta)\\\\right]^2$$\")))),\r\n                    column(6,\r\n                           h5(\"Parameter Definitions\", style = \"color: #000;\"),\r\n                           tags$div(class = \"symbol-def\", HTML(\"<span class='param-name'>O<sub>j<\/sub><\/span> &mdash; Number of options in item <i>j<\/i>. \")),\r\n                           tags$div(class = \"symbol-def\", HTML(\"<span class='param-name'>X<sub>j<\/sub><\/span> &mdash; Number of valid RCs in item <i>j<\/i>.\")),\r\n                           tags$div(class = \"symbol-def\", HTML(\"<span class='param-name'>&theta;<sub>i<\/sub><\/span> &mdash; Latent trait (ability) of person <i>i<\/i>.\")),\r\n                           tags$div(class = \"symbol-def\", HTML(\"<span class='param-name'>a<sub>jo<\/sub><\/span> &mdash; Slope (discrimination) parameter for option <i>o<\/i> in item <i>j<\/i>. \"), HTML(\"Positive for correct options (attractiveness increases with &theta;); negative for incorrect options.\")),\r\n                           tags$div(class = \"symbol-def\", HTML(\"<span class='param-name'>d<sub>jo<\/sub><\/span> &mdash; Intercept parameter for option <i>o<\/i> in item <i>j<\/i>. \"), HTML(\"Baseline attractiveness when &theta;<sub>i<\/sub> = 0.\")),\r\n                           tags$div(class = \"symbol-def\", HTML(\"<span class='param-name'>a*<sub>j<\/sub><\/span> &mdash; Local dependence magnitude for item <i>j<\/i>. \"), HTML(\"When a*<sub>j<\/sub> = 0, MRM-LD reduces to MRM.\")),\r\n                           tags$div(class = \"symbol-def\", HTML(\"<span class='param-name'>&gamma;<sub>ij<\/sub><\/span> &mdash; Person-item specific ability factor. \"), HTML(\"Reflects specific abilities related to the item beyond &theta;.\")),\r\n                           tags$div(class = \"symbol-def\", HTML(\"<span class='param-name'>W<sub>jo<\/sub><\/span> &mdash; Correctness indicator: +1 for pre-defined correct, &minus;1 for pre-defined incorrect options.\")),\r\n                           tags$div(class = \"symbol-def\", HTML(\"<span class='param-name'>Z<sub>jxo<\/sub><\/span> &mdash; Design matrix element: 1 if option <i>o<\/i> is selected in RC <i>x<\/i>, 0 otherwise.\")))))\r\n    )\r\n  ),\r\n  div(class = \"citation-footer\",\r\n      tags$b(\"Cite: \"),\r\n      \"Zhou, W., & Guo, L. (2026). Psychometric Model Framework for Multiple Response Items. \",\r\n      tags$i(\"Psychometrika\"), \". \",\r\n      tags$a(href = \"https://doi.org/10.1017/psy.2025.10073\", target = \"_blank\", \"doi:10.1017/psy.2025.10073\"))\r\n)\r\n\r\n# ==============================================================================\r\n# 3. Server Logic (Optimized with caching)\r\n# ==============================================================================\r\n\r\nserver <- function(input, output, session) {\r\n  \r\n  cached_patterns <- reactiveVal(NULL)\r\n  cached_O_j <- reactiveVal(NULL)\r\n  \r\n  get_patterns <- reactive({\r\n    O_j <- min(input$O_j, 8)\r\n    if (is.null(cached_O_j()) || cached_O_j() != O_j) {\r\n      cached_O_j(O_j); cached_patterns(get_all_patterns(O_j))\r\n    }\r\n    cached_patterns()\r\n  })\r\n  \r\n  output$oj_warning_ui <- renderUI({\r\n    req(input$O_j)\r\n    if (input$O_j >= 8) div(class = \"key-warning\", tags$b(\"Warning: \"), HTML(\"To avoid performance issues, number of options is limited to a maximum of 8.\"))\r\n  })\r\n  \r\n  \r\n  output$key_ui <- renderUI({\r\n    req(input$O_j); O_j <- min(input$O_j, 8)\r\n    checkbox_list <- lapply(1:O_j, function(o) column(3, checkboxInput(paste0(\"key_bit_\", o), paste0(\"O\", o), value = o <= ceiling(O_j/2))))\r\n    fluidRow(do.call(tagList, checkbox_list))\r\n  })\r\n  \r\n  current_key <- reactive({\r\n    req(input$O_j); O_j <- min(input$O_j, 8)\r\n    sapply(1:O_j, function(o) { val <- input[[paste0(\"key_bit_\", o)]]; if(is.null(val)) as.numeric(o <= ceiling(O_j/2)) else as.numeric(val) })\r\n  })\r\n  \r\n  key_valid <- reactive({\r\n    req(input$itemtype)\r\n    if (input$itemtype != \"Select-N\") return(TRUE)\r\n    key_vals <- current_key(); T_correct <- sum(key_vals)\r\n    T_correct > 0 && T_correct < length(key_vals)\r\n  })\r\n  \r\n  output$key_warning_ui <- renderUI({\r\n    req(input$itemtype)\r\n    if (input$itemtype == \"Select-N\" && !key_valid()) {\r\n      key_vals <- current_key(); T_correct <- sum(key_vals); O_j <- length(key_vals)\r\n      msg <- if (T_correct == 0) \"For Select-N items, at least one option must be marked as correct.\"\r\n      else if (T_correct == O_j) \"For Select-N items, at least one option must be marked as incorrect.\"\r\n      else \"Invalid answer key configuration.\"\r\n      div(class = \"key-warning\", tags$b(\"Invalid Key: \"), msg)\r\n    }\r\n  })\r\n  \r\n  make_key_watcher <- function(n) {\r\n    observeEvent(input[[paste0(\"key_bit_\", n)]], {\r\n      current_a <- input[[paste0(\"a_param_\", n)]]; key_val <- input[[paste0(\"key_bit_\", n)]]\r\n      if (!is.null(current_a) && !is.null(key_val)) {\r\n        if (key_val && current_a < 0) updateNumericInput(session, paste0(\"a_param_\", n), value = round(abs(current_a), 2))\r\n        else if (!key_val && current_a > 0) updateNumericInput(session, paste0(\"a_param_\", n), value = round(-abs(current_a), 2))\r\n      }\r\n    }, ignoreInit = TRUE)\r\n  }\r\n  lapply(1:8, make_key_watcher)\r\n  \r\n  output$ld_warning_ui <- renderUI({\r\n    req(input$O_j, input$itemtype)\r\n    if (input$itemtype == \"Select-N\") {\r\n      T_correct <- sum(current_key()); O_j <- min(input$O_j, 8)\r\n      if (T_correct == 1 || T_correct == (O_j - 1))\r\n        return(div(class = \"ld-warning\", tags$b(\"Note: \"), HTML(\"Local Dependence is not applicable for single-choice items (Select-N with T=1 or T=O<sub>j<\/sub>‚àí1). The LD parameters below will have no effect.\")))\r\n    }\r\n    NULL\r\n  })\r\n  \r\n  initial_params <- reactive({\r\n    req(input$O_j); O_j <- min(input$O_j, 8); set.seed(123)\r\n    key_vals <- c(rep(1, ceiling(O_j/2)), rep(0, O_j - ceiling(O_j/2)))\r\n    a_vals <- sapply(1:O_j, function(o) { mag <- runif(1, 0.5, 2.5); if(key_vals[o] == 1) mag else -mag })\r\n    list(a = round(a_vals, 2), d = round(runif(O_j, -2, 2), 2))\r\n  })\r\n  \r\n  output$dynamic_params_ui <- renderUI({\r\n    req(input$O_j); O_j <- min(input$O_j, 8); init <- initial_params()\r\n    input_list <- lapply(1:O_j, function(o) {\r\n      tags$div(class = \"param-row\",\r\n               tags$div(class = \"param-label-col\", paste0(\"O\", o)),\r\n               tags$div(class = \"param-input-col\", numericInput(paste0(\"a_param_\", o), NULL, init$a[o], step = 0.1)),\r\n               tags$div(class = \"param-input-col\", numericInput(paste0(\"d_param_\", o), NULL, init$d[o], step = 0.1)))\r\n    })\r\n    tagList(\r\n      tags$div(class = \"param-header-row\",\r\n               tags$div(class = \"param-label-col\", \"\"),\r\n               tags$div(class = \"param-input-col\", HTML(\"a<sub>jo<\/sub>\")),\r\n               tags$div(class = \"param-input-col\", HTML(\"d<sub>jo<\/sub>\"))),\r\n      do.call(tagList, input_list))\r\n  })\r\n  \r\n  observeEvent(input$random_btn, {\r\n    req(input$O_j); O_j <- min(input$O_j, 8); key_vals <- current_key()\r\n    for(o in 1:O_j) {\r\n      mag_a <- runif(1, 0.5, 2.5)\r\n      updateNumericInput(session, paste0(\"a_param_\", o), value = round(if(key_vals[o] == 1) mag_a else -mag_a, 2))\r\n      updateNumericInput(session, paste0(\"d_param_\", o), value = round(runif(1, -2, 2), 2))\r\n    }\r\n    showNotification(\"Parameters randomized\", type = \"message\")\r\n  })\r\n  \r\n  current_inputs <- reactive({\r\n    req(input$O_j); O_j <- min(input$O_j, 8); init <- initial_params(); key_vals <- current_key()\r\n    a_vals <- sapply(1:O_j, function(o) { val <- input[[paste0(\"a_param_\", o)]]; if(is.null(val)) init$a[o] else val })\r\n    d_vals <- sapply(1:O_j, function(o) { val <- input[[paste0(\"d_param_\", o)]]; if(is.null(val)) init$d[o] else val })\r\n    is_norm <- FALSE\r\n    if (input$itemtype == \"Select-N\" && isTRUE(input$normalize_selectn)) {\r\n      a_vals <- a_vals - mean(a_vals); d_vals <- d_vals - mean(d_vals); is_norm <- TRUE\r\n    }\r\n    list(a = a_vals, d = d_vals, Key = key_vals, is_norm = is_norm)\r\n  })\r\n  \r\n  output$z_matrix_display <- renderTable({\r\n    req(input$O_j, input$itemtype)\r\n    if (input$itemtype == \"Select-N\" && !key_valid()) return(NULL)\r\n    O_j <- min(input$O_j, 8); full_pats <- get_patterns()\r\n    valid_pats <- filter_patterns(full_pats, input$itemtype, current_key())\r\n    pattern_strings <- apply(valid_pats, 1, paste, collapse = \"\")\r\n    num_ones <- rowSums(valid_pats)\r\n    pattern_values <- apply(valid_pats, 1, function(row) sum(row * (2^((O_j-1):0))))\r\n    z_df <- as.data.frame(valid_pats); colnames(z_df) <- paste0(\"O\", 1:O_j)\r\n    z_df$RC <- pattern_strings; z_df$num_ones <- num_ones; z_df$pattern_val <- pattern_values\r\n    z_df <- z_df[order(z_df$num_ones, -z_df$pattern_val), ]\r\n    z_df$num_ones <- NULL; z_df$pattern_val <- NULL\r\n    cbind(x = 1:nrow(z_df), RC = z_df$RC, z_df[, paste0(\"O\", 1:O_j)])\r\n  }, striped = TRUE, bordered = TRUE, hover = TRUE, spacing = \"xs\", align = \"c\", digits = 0)\r\n  \r\n  plot_data <- reactive({\r\n    if (input$itemtype == \"Select-N\" && !key_valid()) return(NULL)\r\n    inputs <- current_inputs(); req(input$x_min, input$x_max)\r\n    theta <- seq(input$x_min, input$x_max, length.out = 100)\r\n    valid_pats <- filter_patterns(get_patterns(), input$itemtype, inputs$Key)\r\n    if (isTRUE(input$show_marginal)) {\r\n      g_points <- seq(-3, 3, length.out = 15); g_weights <- dnorm(g_points); g_weights <- g_weights / sum(g_weights)\r\n      df_final <- calculate_mrm_ld_prob(theta, inputs$a, inputs$d, input$a_star, 0, inputs$Key, valid_pats)\r\n      df_final$Prob <- 0\r\n      for (k in seq_along(g_points)) {\r\n        temp <- calculate_mrm_ld_prob(theta, inputs$a, inputs$d, input$a_star, g_points[k], inputs$Key, valid_pats)\r\n        df_final$Prob <- df_final$Prob + temp$Prob * g_weights[k]\r\n      }\r\n      df_final\r\n    } else calculate_mrm_ld_prob(theta, inputs$a, inputs$d, input$a_star, input$gamma, inputs$Key, valid_pats)\r\n  })\r\n  \r\n  output$rccc_plot <- renderPlot({\r\n    df <- plot_data()\r\n    if (is.null(df)) { plot.new(); text(0.5, 0.5, \"Please configure a valid Answer Key for Select-N items.\\n(Cannot have all options selected or none selected)\", cex = 1.2, col = \"#721c24\"); return() }\r\n    O_j <- min(input$O_j, 8); is_marginal <- isTRUE(input$show_marginal)\r\n    plot_title <- if(is_marginal) \"Response Combination Characteristic Curves (RCCC) ‚Äî Marginal\" else \"Response Combination Characteristic Curves (RCCC) ‚Äî Conditional\"\r\n    plot_subtitle <- if(is_marginal) \"Probabilities integrated over Œ≥ ~ N(0,1)\" else bquote(\"Conditional on \" * gamma[ij] == .(input$gamma))\r\n    \r\n    df_sum <- aggregate(Prob ~ Theta + Score, df, sum)\r\n    df_sum$Pattern <- \"Cumulative\"; df_sum$Category <- \"Cumulative\"; df_sum$Rank <- 999\r\n    max_probs <- aggregate(Prob ~ Score + Pattern, df, max); names(max_probs)[3] <- \"MaxVal\"\r\n    max_probs <- max_probs[order(max_probs$Score, -max_probs$MaxVal), ]\r\n    max_probs$Rank <- ave(max_probs$MaxVal, max_probs$Score, FUN = function(x) seq_along(x))\r\n    df <- merge(df, max_probs[, c(\"Score\", \"Pattern\", \"Rank\")], by = c(\"Score\", \"Pattern\"), all.x = TRUE)\r\n    df$Category <- ifelse(df$Rank == 1, \"1st RC\", ifelse(df$Rank == 2, \"2nd RC\", \"Other\"))\r\n    df$Theta <- as.numeric(df$Theta)\r\n    df_sum_filtered <- df_sum[df_sum$Score > 0 & df_sum$Score < O_j, ]\r\n    df_top <- df[df$Rank <= 2, ]\r\n    df_labels <- do.call(rbind, lapply(split(df_top, list(df_top$Score, df_top$Pattern)), function(x) x[which.max(x$Prob), ]))\r\n    \r\n    my_colors <- c(\"Cumulative\" = \"#E41A1C\", \"1st RC\" = \"#1B9E77\", \"2nd RC\" = \"#377EB8\", \"Other\" = \"#999999\")\r\n    my_linetypes <- c(\"Cumulative\" = \"dashed\", \"1st RC\" = \"solid\", \"2nd RC\" = \"solid\", \"Other\" = \"solid\")\r\n    my_labels <- c(\"Cumulative\" = \"Cumulative (sum of RC probs)\", \"1st RC\" = \"1st highest prob RC\", \"2nd RC\" = \"2nd highest prob RC\", \"Other\" = \"Other RCs\")\r\n    \r\n    p <- ggplot() +\r\n      geom_line(data = df[df$Category == \"Other\", ], aes(x = Theta, y = Prob, group = Pattern, color = \"Other\", linetype = \"Other\"), linewidth = 0.4, alpha = 0.5) +\r\n      geom_line(data = df[df$Category %in% c(\"1st RC\", \"2nd RC\"), ], aes(x = Theta, y = Prob, group = Pattern, color = Category, linetype = Category), linewidth = 0.8) +\r\n      geom_text(data = df_labels, aes(x = Theta, y = Prob, label = Pattern, color = Category), vjust = -0.5, size = 3.5, fontface = \"bold\", show.legend = FALSE) +\r\n      geom_line(data = df_sum_filtered, aes(x = Theta, y = Prob, group = Score, color = \"Cumulative\", linetype = \"Cumulative\"), linewidth = 0.9) +\r\n      scale_color_manual(name = \"Legend\", values = my_colors, labels = my_labels, breaks = c(\"Cumulative\", \"1st RC\", \"2nd RC\", \"Other\")) +\r\n      scale_linetype_manual(name = \"Legend\", values = my_linetypes, labels = my_labels, breaks = c(\"Cumulative\", \"1st RC\", \"2nd RC\", \"Other\")) +\r\n      facet_wrap(~Score, labeller = labeller(Score = function(x) paste0(\"Score = \", x)), scales = \"fixed\", nrow = 2) +\r\n      scale_x_continuous(limits = c(input$x_min, input$x_max)) +\r\n      scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.25)) +\r\n      coord_cartesian(clip = \"on\") +\r\n      theme_bw(base_size = 14) +\r\n      theme(panel.grid.minor = element_blank(), strip.background = element_rect(fill = \"#f0f0f0\"),\r\n            strip.text = element_text(size = 12, face = \"bold\"), legend.position = \"bottom\",\r\n            legend.title = element_blank(), legend.text = element_text(size = 11),\r\n            legend.key.width = unit(2, \"cm\"), axis.title = element_text(size = 14),\r\n            axis.text = element_text(size = 12), plot.title = element_text(size = 16, face = \"bold\"),\r\n            plot.subtitle = element_text(size = 14, color = \"#555\"), plot.margin = margin(10, 10, 10, 10)) +\r\n      guides(color = guide_legend(nrow = 1, override.aes = list(linewidth = 1.2)), linetype = guide_legend(nrow = 1)) +\r\n      labs(x = expression(theta~\" (Latent Trait)\"), y = expression(P(RC~\"|\"~theta)), title = plot_title, subtitle = plot_subtitle)\r\n    print(p)\r\n  })\r\n  \r\n  output$info_plot <- renderPlot({\r\n    if (input$itemtype == \"Select-N\" && !key_valid()) { plot.new(); text(0.5, 0.5, \"Please configure a valid Answer Key\", cex = 1.2, col = \"#721c24\"); return() }\r\n    inputs <- current_inputs(); req(input$x_min, input$x_max)\r\n    theta <- seq(input$x_min, input$x_max, length.out = 100)\r\n    valid_pats <- filter_patterns(get_patterns(), input$itemtype, inputs$Key)\r\n    is_marginal <- isTRUE(input$show_marginal)\r\n    info <- if(is_marginal) calculate_mrm_info_marginal(theta, inputs$a, inputs$d, input$a_star, inputs$Key, valid_pats)\r\n    else calculate_mrm_info(theta, inputs$a, inputs$d, input$a_star, input$gamma, inputs$Key, valid_pats)\r\n    plot_title <- if(is_marginal) \"Item Information Function ‚Äî Marginal\" else \"Item Information Function ‚Äî Conditional\"\r\n    plot_subtitle <- if(is_marginal) \"Information integrated over Œ≥ ~ N(0,1)\" else bquote(\"Conditional on \" * gamma[ij] == .(input$gamma))\r\n    df_info <- data.frame(Theta = theta, Information = info)\r\n    ggplot(df_info, aes(x = Theta, y = Information)) +\r\n      geom_line(color = \"#0072B2\", linewidth = 1.2) + geom_area(alpha = 0.2, fill = \"#0072B2\") +\r\n      theme_bw(base_size = 14) +\r\n      theme(axis.title = element_text(size = 14), axis.text = element_text(size = 12),\r\n            plot.title = element_text(size = 16, face = \"bold\"), plot.subtitle = element_text(size = 14, color = \"#555\")) +\r\n      labs(x = expression(theta~\" (Latent Trait)\"), y = expression(I(theta)), title = plot_title, subtitle = plot_subtitle)\r\n  })\r\n  \r\n  output$info_params_display <- renderPrint({\r\n    if (input$itemtype == \"Select-N\" && !key_valid()) { cat(\"Invalid Answer Key configuration.\\n\"); cat(\"Please select at least one correct and one incorrect option.\"); return() }\r\n    inputs <- current_inputs(); O_j <- min(input$O_j, 8)\r\n    valid_pats <- filter_patterns(get_patterns(), input$itemtype, inputs$Key)\r\n    cat(\"Item Type:\", input$itemtype, \"\\n\"); cat(\"Oj (Options):\", O_j, \"\\n\")\r\n    cat(\"Xj (Valid RCs):\", nrow(valid_pats), \"\\n\"); cat(\"T (Correct):\", sum(inputs$Key), \"\\n\\n\")\r\n    cat(\"Answer Key:\", paste(inputs$Key, collapse = \"\"), \"\\n\\n\")\r\n    cat(\"Option Parameters:\\n\")\r\n    for(o in 1:O_j) cat(sprintf(\"  O%d: a=%6.2f, d=%6.2f, W=%+d\\n\", o, inputs$a[o], inputs$d[o], ifelse(inputs$Key[o] == 1, 1, -1)))\r\n    cat(\"\\nLocal Dependence:\\n\"); cat(\"  a*j =\", input$a_star, \"\\n\")\r\n    if (isTRUE(input$show_marginal)) cat(\"  gamma: integrated (marginal)\\n\") else cat(\"  gamma_ij =\", input$gamma, \"\\n\")\r\n    if(inputs$is_norm) cat(\"\\n[Sum-to-zero applied]\\n\")\r\n  })\r\n}\r\n\r\nshinyApp(ui, server)","type":"text"},{"name":"deploy_shinylive.R","content":"# ============================================================\r\n# Shinylive Deployment Script\r\n# ============================================================\r\n# This script exports your Shiny app to run in the browser\r\n# using shinylive (WebAssembly-powered R)\r\n# ============================================================\r\n\r\ncat(\"üöÄ MRM-LD Shinylive Deployment Script\\n\")\r\ncat(\"====================================\\n\\n\")\r\n\r\n# Check if shinylive is installed\r\nif (!require(\"shinylive\", quietly = TRUE)) {\r\n  cat(\"üì¶ Installing shinylive package...\\n\")\r\n  install.packages(\"shinylive\")\r\n}\r\n\r\nlibrary(shinylive)\r\n\r\n# Export the app\r\ncat(\"üîÑ Exporting app to shinylive format...\\n\")\r\ncat(\"   This may take a few minutes...\\n\\n\")\r\n\r\nshinylive::export(\r\n  appdir = \".\",           # Current directory (contains app.R)\r\n  destdir = \"docs\"        # Output to docs/ for GitHub Pages\r\n)\r\n\r\ncat(\"\\n‚úÖ Export complete!\\n\\n\")\r\ncat(\"üìã Next steps:\\n\")\r\ncat(\"   1. Add and commit the changes:\\n\")\r\ncat(\"      git add .\\n\")\r\ncat(\"      git commit -m 'Deploy shinylive version'\\n\")\r\ncat(\"      git push origin main\\n\\n\")\r\ncat(\"   2. Enable GitHub Pages:\\n\")\r\ncat(\"      - Go to your repo Settings > Pages\\n\")\r\ncat(\"      - Source: main branch, /docs folder\\n\")\r\ncat(\"      - Click Save\\n\\n\")\r\ncat(\"   3. Your app will be live at:\\n\")\r\ncat(\"      https://zhouwenjie26.github.io/Multiple_Response_Model_Interactive_Visualization_System/\\n\\n\")\r\ncat(\"‚è±Ô∏è  Note: GitHub Pages may take 2-5 minutes to build.\\n\")\r\ncat(\"    First load will take ~30-60 seconds for R/WebAssembly initialization.\\n\")\r\n","type":"text"}]
